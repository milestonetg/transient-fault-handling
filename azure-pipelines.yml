name: $(ReleaseVersionNumber).$(Build)
variables:
  ReleaseVersionNumber: 2.0.0
  Build: $[counter(variables['ReleaseVersionNumber'], 1)]
  CicdVersionNumber: $(ReleaseVersionNumber)-beta$(Build)
  AssemblyVersion: $(Build.BuildNumber)
  InformationalVersion: $(Build.BuildNumber)

trigger:
  paths:
    include:
      - src
    
jobs:
  - job:
    displayName: 'Build, test, pacakge'
    pool:
      vmImage: windows-latest
    steps:
      - task: DotNetCoreCLI@2
        displayName: Restore packages
        inputs:
          command: restore
          configuration: release
          projects: |
            **/*.csproj

      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          command: build
          arguments: --no-restore -p:Version=$(AssemblyVersion) -p:InformationalVersion=$(InformationalVersion)
          configuration: release
          projects: |
            src/**/*.csproj
            
      - task: DotNetCoreCLI@2
        displayName: Pack for unstable
        inputs:
          command: pack
          nobuild: true
          configuration: release
          packagesToPack: |
            src/**/*.csproj
          packDirectory: '$(Build.ArtifactStagingDirectory)/cicd'
          versioningScheme: byEnvVar
          versionEnvVar: CicdVersionNumber

      - task: DotNetCoreCLI@2
        displayName: Pack for stable
        inputs:
          command: pack
          nobuild: true
          configuration: release
          packagesToPack: |
            src/**/*.csproj
          packDirectory: '$(Build.ArtifactStagingDirectory)/cicd'
          versioningScheme: byEnvVar
          versionEnvVar: ReleaseVersionNumber

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: drop'
